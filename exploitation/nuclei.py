import os
import sys
sys.path.insert(0,os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
import methods
import threads
import time
class nuclei:

    def __init__(self, end_points=[], threads=1, delay=0):
        self.end_points = end_points
        self.reports = {}
        self.errors={'end_points':[], 'general':None}
        self.threads=threads
        self.delay=delay

    def str_flags(self,flags,end_point):
        flags["-u"] = f'"{end_point}"'
        return methods.dic_to_str(flags,postfix=' ')

    def nuclei_execute(self,str_flags,id):
        command = f"nuclei {str_flags} -nc 1> nuclei_out{id}.txt 2> /dev/null"
        print(command)
        methods.execute_command(command)
        lines = methods.get_file_content(f"nuclei_out{id}.txt","\n")
        print('Lines: ',lines)
        if lines:
            return lines
        else:
            return False
    
    def nuclei(self,end_point,flags={},id=0):
        str_flags = self.str_flags(flags, end_point)
        output=self.nuclei_execute(str_flags,id)
        if output:
            self.reports[end_point]=output
        else:
            self.errors['end_points'].append(end_point)
    
    def lnuclei(self, flags={}):
        print("[‚óè] Vulnerabilities Scanning  -  nuclei")
        try:
            counter = 1
            iterations = len(self.end_points) // self.threads + 1
            for i in range(0,iterations):
                thread_objects = []
                for end_point in self.end_points:
                    t = threads.thread(self.nuclei,(end_point,flags,counter))
                    counter+=1
                    thread_objects.append(t)
                for obj in thread_objects:
                    obj.join()
                time.sleep(self.delay)
        except Exception as e:
            self.errors['general'] = e  