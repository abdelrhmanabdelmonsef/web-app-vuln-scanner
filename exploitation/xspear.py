import os
import sys
sys.path.insert(0,os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
import methods
import threads
import json

global_path = '/home/kali/Desktop/WEB VULNARABILITY SCANNER'

class xspear:

    def __init__(self, end_points=[], threads=1, delay=0):
        self.end_points = end_points
        self.reports = {}
        self.errors={'end_points':[], 'general':None}
        self.threads=threads

    def str_flags(self,flags,end_point):
        flags["-u"] = f'"{end_point}"'
        flags["-v"]= "0"
        flags["-o"]="json"
        return methods.dic_to_str(flags,postfix=' ')
    
    def xspear_execute(self,str_flags):
        command = f"XSpear {str_flags}"
        _,out,err=methods.execute_command(command)
        if not err:
            return out
        else:
            return False
	
    def xspear(self,end_point,flags={}):
        xspear_result = self.xspear_execute(self.str_flags(flags,end_point))
        if xspear_result:
            out_lines = xspear_result.strip().split('\n')
            report=json.loads(out_lines[0])
            self.reports[end_point]=report
        else:
            self.errors['end_points'].append(end_point)

    def xspear_threads(self,i,flags={}):
        thread_objects = []
        start_index = i * self.threads
        end_index = start_index + self.threads
        for end_point in self.end_points[start_index:end_index]:
            t = threads.thread(self.xspear,args=(end_point,flags))
            thread_objects.append(t)
        threads.join_threads(thread_objects)
        
    def lxspear(self, flags={}):
        print("[‚óè] Vulnerabilities Scanning  -  xspear")
        try:
            iterations = len(self.end_points) // self.threads + 1
            for i in range(0,iterations):
                self.xspear_threads(i,flags)
        except Exception as e:
            self.errors['general'] = e
