import os
import sys
sys.path.insert(0,os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
import methods
import threads

global_path = '/home/kali/Desktop/WEB VULNARABILITY SCANNER'
class xsstrike:

    def __init__(self, end_points=[], threads=1, delay=0):
        self.end_points = end_points
        self.reports = {}
        self.errors={'end_points':[], 'general':None}
        self.threads=threads

    def str_flags(self,flags,end_point):
        flags["-u"] = f'"{end_point}"'
        flags["--file-log-level"]="INFO"
        flags["-t"]="10"
        flags["--crawl"]="-l 1"
        return methods.dic_to_str(flags,postfix=' ')

    def xsstrike_execute(self,str_flags):
        command = f"python3 {global_path}/XSStrike/xsstrike.py {str_flags} 2> /dev/null"
        print(command)
        _,out,err=methods.execute_command(command)
        if not err:
            return out
        else:
            return False

    def xsstrike(self,end_point,flags={}):
        xsstrike_result = self.xsstrike_execute(self.str_flags(flags,end_point))
        if xsstrike_result:
            out_lines = xsstrike_result.strip().split('\n')
            payloads=[line.split(": ")[-1].split(" ")[0] for line in out_lines if "Vector" in line]
            self.reports[end_point]=payloads
        else:
            self.errors['end_points'].append(end_point)

    def xsstrike_threads(self,i,flags={}):
        thread_objects = []
        start_index = i * self.threads
        end_index = start_index + self.threads
        for end_point in self.end_points[start_index:end_index]:
            t = threads.thread(self.xsstrike,args=(end_point,flags))
            thread_objects.append(t)
        threads.join_threads(thread_objects)
    
    def lxsstrike(self, flags={}):
        print("[â—] Vulnerabilities Scanning  -  Xsstrike")
        try:
            iterations = len(self.end_points) // self.threads + 1
            for i in range(0,iterations):
                self.xsstrike_threads(i,flags)
        except Exception as e:
            self.errors['general'] = e  


